<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>QR Scanner</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <script src="jsQR.min.js"></script>
  <script src="jspdf.umd.min.js"></script>
  <script src="jspdf.plugin.autotable.min.js"></script>
  <style>
    :root {
      --primary: #edb200e8;
      --primary-dark: #5a5056;
      --secondary: #edb200;
      --error: #edb200e8;
      --success: #edb200e8;
      --warning: #edb200e8;
      --background: #000000;
      --surface: #000000;
      --on-surface: #f8fafc;
      --on-surface-secondary: #cbd5e1;
      --error-text: #44020b;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      margin: 0;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      color: #e0e0e0;
      background-color: var(--background);
      position: relative;
      overflow: hidden;
      font-family: 'Segoe UI', -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 12.6px;
    }
    .app-container { display: flex; flex-direction: column; height: 100vh; width: 100%; }
    .scanner-section { flex: 1; position: relative; display: flex; flex-direction: column; justify-content: center; align-items: center; background-color: #000; overflow: hidden; }
    .controls-container { position: fixed; bottom: 15px; left: 0; right: 0; padding: 10px; z-index: 10; display: flex; justify-content: center; }
    .history-section { position: fixed; top: 0; right: 0; width: 85%; max-width: 320px; height: 100vh; background-color: var(--surface); padding: 15px; box-shadow: -2px 0 15px rgba(0, 0, 0, 0.5); overflow-y: auto; z-index: 100; transform: translateX(100%); transition: transform 0.3s ease; }
    .history-section.active { transform: translateX(0); }
    .student-list-section {
      position: fixed;
      top: 0; left: 0; width: 100%; height: 100vh;
      background-color: var(--background);
      z-index: 200;
      display: none;
      flex-direction: column;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.4s;
    }
    .student-list-section.active {
      display: flex;
      opacity: 1;
      pointer-events: auto;
      animation: fadeInStudent 0.4s;
    }
    .student-list-section.fade-out {
      opacity: 0;
      pointer-events: none;
      animation: fadeOutStudent 0.4s;
    }
    @keyframes fadeInStudent {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    @keyframes fadeOutStudent {
      from { opacity: 1; }
      to { opacity: 0; }
    }
    .student-list-modal { background-color: var(--surface); padding: 20px; width: 100%; height: 100%; overflow-y: auto; display: flex; flex-direction: column; transform: scale(0.95); transition: transform 0.3s ease; }
    .student-list-section.active .student-list-modal { transform: scale(1); }
    .student-list-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px 0; border-bottom: 2px solid rgba(255, 255, 255, 0.1); flex-shrink: 0; }
    .student-list-title { font-size: 19.8px; font-weight: 600; color: var(--on-surface); margin: 0; }
    .close-student-list { background: none; border: none; color: var(--on-surface-secondary); cursor: pointer; font-size: 20px; padding: 5px; border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; }
    .close-student-list:hover { background-color: rgba(255, 255, 255, 0.1); color: var(--on-surface); }
    .student-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    .student-table th, .student-table td { padding: 13.5px 10.8px; text-align: left; border-bottom: 1px solid rgba(255, 255, 255, 0.1); font-size: 10.6px; }
    .student-table th { background-color: var(--primary); color: white; font-weight: 600; position: sticky; top: 0; z-index: 10; }
    .student-table tr:nth-child(even) { background-color: rgba(255, 255, 255, 0.05); }
    .student-table tr:hover { background-color: rgba(255, 255, 255, 0.1); }
    .student-table td { color: var(--on-surface); word-break: break-word; }
    .empty-student-list { text-align: center; color: var(--on-surface-secondary); padding: 27px 18px; font-size: 12.6px; }
    .toggle-history { position: fixed; top: 15px; right: 15px; background-color: var(--primary); color: white; border: none; border-radius: 50%; width: 40.5px; height: 40.5px; display: flex; justify-content: center; align-items: center; z-index: 101; cursor: pointer; box-shadow: 0 3.6px 10.8px rgba(0, 0, 0, 0.3); background-image: url('icon4.png'); background-size: 55%; background-position: center; background-repeat: no-repeat; }
    .toggle-student-list { position: fixed; top: 70px; right: 15px; background-color: var(--primary); color: white; border: none; border-radius: 50%; width: 40.5px; height: 40.5px; display: flex; justify-content: center; align-items: center; z-index: 101; cursor: pointer; box-shadow: 0 3.6px 10.8px rgba(0, 0, 0, 0.3); background-image: url('icon5.png'); background-size: 55%; background-position: center; background-repeat: no-repeat; }
    .status { display: none; }
    .timer { position: fixed; top: 15px; left: 15px; font-size: 11.7px; font-weight: bold; color: var(--secondary); background-color: rgba(0, 0, 0, 0.6); padding: 5.4px 10.8px; border-radius: 18px; z-index: 10; backdrop-filter: blur(4px); }
    .scanner-container { position: relative; width: 100%; height: 100%; overflow: hidden; display: flex; justify-content: center; align-items: center; }
    video { width: 100%; height: 100%; object-fit: cover; display: none; }
    .scanner-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; display: none; }
    .scanner-guide { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); width: 70vmin; height: 70vmin; max-width: 300px; max-height: 300px; border: 2px solid rgba(255, 255, 255, 0.6); border-radius: 12px; box-shadow: 0 0 0 4000px rgba(0, 0, 0, 0.3); display: none; }
    #result { position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background-color: rgba(0, 0, 0, 0.9); backdrop-filter: blur(10px); color: #fff; padding: 13.5px 18px; border-radius: 12.6px; font-size: 13.5px; font-weight: 500; display: none; z-index: 20; text-align: center; max-width: 85%; word-break: break-word; box-shadow: 0 7.2px 27px rgba(0, 0, 0, 0.5); border: 1px solid rgba(255, 255, 255, 0.15); animation: fadeIn 0.3s ease; }
    @keyframes fadeIn { from { opacity: 0; transform: translate(-50%, -40%); } to { opacity: 1; transform: translate(-50%, -50%); } }
    .controls { display: flex; justify-content: center; gap: 20px; }
    .btn { width: 54px; height: 54px; border-radius: 50%; border: none; color: #fff; cursor: pointer; transition: all 0.3s; display: flex; justify-content: center; align-items: center; font-size: 21.6px; box-shadow: 0 3.6px 10.8px rgba(0, 0, 0, 0.3); background-size: 60%; background-position: center; background-repeat: no-repeat; }
    .btn:hover { opacity: 0.9; transform: translateY(-3px); }
    .btn:active { transform: translateY(1px); box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3); }
    .btn-file { background-color: var(--warning); background-image: url('icon3.png'); }
    .btn-start { background-color: var(--success); background-image: url('icon1.png'); }
    .btn-stop { background-color: var(--error); background-image: url('icon2.png'); }
    input[type="file"] { display: none; }
    .history { background-color: #080808e8; border-radius: 12px; padding: 10px; box-shadow: 0 4px 15px #0e0e0d00; height: calc(96% - 50px); display: flex; flex-direction: column; }
    .history-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255, 255, 255, 0.1); }
    .history-title { font-size: 18px; font-weight: 600; margin: 0; color: var(--on-surface); }
    .history-count { font-size: 12px; color: var(--on-surface-secondary); background-color: rgba(255, 255, 255, 0.1); padding: 4px 8px; margin-right: 14%; border-radius: 12px; }
    .history-list { flex: 1; overflow-y: auto; -webkit-overflow-scrolling: touch; margin-bottom: 15px; }
    .empty-history { color: var(--on-surface-secondary); text-align: center; padding: 30px 15px; font-size: 14px; }
    .history-item { padding: 12px; margin-bottom: 10px; background-color: rgba(255, 255, 255, 0.08); border-radius: 10px; display: flex; flex-direction: column; transition: all 0.2s; border-left: 4px solid #202020; }
    .history-item:active { background-color: rgba(255, 255, 255, 0.12); }
    .history-item-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
    .history-item-number { font-weight: 600; margin-right: 8px; color: #edb200; min-width: 20px; }
    .history-item-content { flex: 1; word-break: break-word; font-size: 13px; padding-right: 10px; }
    .history-item-timestamp { font-size: 11px; color: var(--on-surface-secondary); margin-top: 5px; }
    .history-item-actions { display: flex; gap: 8px; }
    .history-item-btn { background: none; border: none; color: var(--on-surface-secondary); cursor: pointer; padding: 5px; font-size: 14px; display: flex; align-items: center; justify-content: center; border-radius: 5px; background-color: rgba(255, 255, 255, 0.1); }
    .history-item-btn:active { color: var(--on-surface); background-color: rgba(255, 255, 255, 0.15); }
    .history-controls { display: flex; gap: 10px; margin-top: 10px; }
    .history-btn { flex: 1; padding: 10px; font-size: 13px; font-weight: 600; border: none; border-radius: 8px; color: #fff; cursor: pointer; display: flex; justify-content: center; align-items: center; gap: 6px; transition: all 0.2s; }
    .history-btn:active { transform: translateY(1px); }
    .history-clear { background-color: var(--error); }
    .history-download { background-color: var(--primary); }
    .toast { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); background-color: #334155; color: white; padding: 12px 20px; border-radius: 8px; font-size: 14px; z-index: 1000; opacity: 0; transition: opacity 0.3s; max-width: 85%; text-align: center; box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2); }
    .toast.show { opacity: 1; }
    .disabled { opacity: 0.5; pointer-events: none; }
    .error-text { color: var(--error-text); }
    .camera-permission { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); text-align: center; color: white; background-color: rgba(0, 0, 0, 0.8); padding: 25px; border-radius: 14px; max-width: 85%; z-index: 5; backdrop-filter: blur(10px); border: 1px solid rgba(255, 255, 255, 0.1); }
    .camera-permission p { margin-bottom: 10px; line-height: 1.5; }
    .camera-permission button { margin-top: 15px; padding: 12px 24px; background-color: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.2s; }
    .camera-permission button:active { transform: translateY(1px); background-color: var(--primary-dark); }
    #passwordModal {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: rgba(0,0,0,0.85);
      z-index: 9999;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: opacity 0.4s;
    }
    #passwordModal.hide { opacity: 0; pointer-events: none; }
    #passwordModal .modal-content {
      background: var(--surface);
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.25);
      padding: 38px 28px 28px 28px;
      text-align: center;
      min-width: 280px;
      animation: fadeInScale 0.5s;
    }
    @keyframes fadeInScale {
      from { opacity: 0; transform: scale(0.85);}
      to { opacity: 1; transform: scale(1);}
    }
    #passwordModal h2 { color: var(--primary); margin-bottom: 18px; font-size: 1.3em; }
    #passwordInput {
      padding: 10px 16px;
      border-radius: 8px;
      border: 1px solid var(--primary);
      font-size: 1em;
      margin-bottom: 16px;
      width: 90%;
      outline: none;
      background: #222;
      color: #fff;
    }
    #passwordBtn {
      background: var(--primary);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 10px 28px;
      font-size: 1em;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    #passwordBtn:active { background: var(--primary-dark);}
    #passwordError { color: var(--error-text); margin-top: 12px; font-size: 0.95em; display: none;}
    @media (max-width: 480px) {
      .controls { gap: 15px; }
      .btn { width: 49.5px; height: 49.5px; font-size: 19.8px; }
      #result { font-size: 12.6px; padding: 10.8px 14.4px; max-width: 90%; }
      .scanner-guide { width: 65vmin; height: 65vmin; }
      .history-section { width: 90%; padding: 12px; }
      #passwordModal .modal-content { min-width: 220px; padding: 28px 12px 18px 12px;}
    }
    @media (max-height: 600px) {
      .btn { width: 45px; height: 45px; font-size: 18px; }
      .controls { gap: 12px; }
      .scanner-guide { width: 60vmin; height: 60vmin; }
    }
  </style>
</head>
<body>
  <div id="passwordModal">
    <div class="modal-content">
      <h2>የይለፍ ቃል ያስገቡ</h2>
      <input id="passwordInput" type="password" placeholder="Password" autofocus />
      <br>
      <button id="passwordBtn">ጀምር</button>
      <div id="passwordError"></div>
    </div>
  </div>
  <div class="app-container">
    <button class="toggle-history" onclick="toggleHistory()"></button>
    <button class="toggle-student-list" onclick="toggleStudentList()"></button>
    <div class="scanner-section">
      <p class="status" id="status">Ready to scan</p>
      <div class="timer" id="timer">20:00</div>
      <div class="scanner-container" id="scannerBox">
        <video id="scanner" playsinline></video>
        <div class="scanner-overlay" id="scannerOverlay">
          <div class="scanner-guide"></div>
        </div>
        <div id="result"></div>
        <div class="camera-permission" id="cameraPermission" style="display: none;">
          <p>Camera access is required to scan QR codes.</p>
          <p>Please allow camera permissions in your browser settings.</p>
          <button onclick="requestCameraPermission()">Grant Permission</button>
        </div>
      </div>
      <div class="controls-container">
        <div class="controls">
          <button class="btn btn-start" onclick="toggleCamera()" id="startBtn"></button>
          <button class="btn btn-file" onclick="document.getElementById('fileInput').click()" id="fileBtn"></button>
        </div>
      </div>
      <input type="file" id="fileInput" accept="image/*" />
    </div>
    <div class="history-section" id="historySection">
      <div class="history">
        <div class="history-header">
          <h2 class="history-title">Scan History</h2>
          <div class="history-count" id="historyCount">0 items</div>
        </div>
        <div class="history-list" id="historyList">
          <div class="empty-history">No scans yet</div>
        </div>
        <div class="history-controls">
          <button class="history-btn history-clear" onclick="clearHistory()" id="clearBtn">
            <span>Clear All</span>
          </button>
          <button class="history-btn history-download" onclick="downloadPDF()" id="downloadBtn">
            <span>Export PDF</span>
          </button>
        </div>
      </div>
    </div>
    <div class="toast" id="toast"></div>
    <div class="student-list-section" id="studentListSection">
      <div class="student-list-modal">
        <div class="student-list-header">
          <h2 class="student-list-title">Student List</h2>
          <button class="close-student-list" onclick="toggleStudentList()">×</button>
        </div>
        <div id="studentListContent">
          <div class="empty-student-list">No students scanned yet</div>
        </div>
      </div>
    </div>
    <audio id="beepSound" preload="auto">
      <source src="beep.mp3" type="audio/mpeg">
    </audio>
  </div>
  <script>
    // Password Modal Logic
    const passwordModal = document.getElementById('passwordModal');
    const passwordInput = document.getElementById('passwordInput');
    const passwordBtn = document.getElementById('passwordBtn');
    const passwordError = document.getElementById('passwordError');
    const PASSWORD = "a";
    function showPasswordModal() {
      passwordModal.classList.remove('hide');
      passwordModal.style.display = 'flex';
      passwordInput.value = '';
      passwordError.style.display = 'none';
      passwordInput.focus();
    }
    function hidePasswordModal() {
      passwordModal.classList.add('hide');
      setTimeout(() => {
        passwordModal.style.display = 'none';
        passwordModal.classList.remove('hide');
      }, 400);
    }
    function checkPassword() {
      if (passwordInput.value.trim() === '') {
        passwordError.textContent = "Enter your password";
        passwordError.style.display = 'block';
        passwordInput.focus();
        return;
      }
      
      if (passwordInput.value === PASSWORD) {
        sessionStorage.setItem('qrAccess', '1');
        hidePasswordModal();
      } else {
        passwordError.textContent = "Incorrect password";
        passwordError.style.display = 'block';
        passwordInput.value = '';
        passwordInput.focus();
      }
    }
    passwordBtn.onclick = checkPassword;
    passwordInput.onkeydown = function(e) {
      if (e.key === 'Enter') checkPassword();
    };
    if (sessionStorage.getItem('qrAccess') !== '1') {
      showPasswordModal();
    } else {
      passwordModal.style.display = 'none';
    }
    window.addEventListener('beforeunload', () => {
      sessionStorage.removeItem('qrAccess');
    });

    const video = document.getElementById("scanner");
    const fileInput = document.getElementById("fileInput");
    const resultDiv = document.getElementById("result");
    const scannerBox = document.getElementById("scannerBox");
    const scannerOverlay = document.getElementById("scannerOverlay");
    const statusText = document.getElementById("status");
    const startBtn = document.getElementById("startBtn");
    const fileBtn = document.getElementById("fileBtn");
    const clearBtn = document.getElementById("clearBtn");
    const historyList = document.getElementById("historyList");
    const historyCount = document.getElementById("historyCount");
    const toast = document.getElementById("toast");
    const beepSound = document.getElementById("beepSound");
    const timerDisplay = document.getElementById("timer");
    const downloadBtn = document.getElementById("downloadBtn");
    const historySection = document.getElementById("historySection");
    const cameraPermission = document.getElementById("cameraPermission");
    const studentListSection = document.getElementById("studentListSection");
    const studentListContent = document.getElementById("studentListContent");

    timerDisplay.addEventListener('dblclick', function() {
      if (timerActive) {
        stopTimer();
        disableAllButtonsExceptPDF();
        // Removed the toast message here
      }
    });

    let stream = null;
    let scanning = false;
    let scanHistory = [];
    let currentScanNumber = 1;
    let lastScannedContent = null;
    let duplicateWarningTimeout = null;
    let scannerTimeout = null;
    let scanTimer = null;
    let timeLeft = 20 * 60; // 20 minutes
    let timerActive = false;
    let isPausedForResultDisplay = false;
    let timerStartTime = null;
    let timerPausedTime = null;
    let noQRTimeout = null; // New variable for 10-second timeout

    function initializeFromStorage() {
      try {
        const savedHistory = localStorage.getItem('qrScanHistory');
        if (savedHistory) {
          scanHistory = JSON.parse(savedHistory);
          currentScanNumber = scanHistory.length > 0 ? scanHistory[scanHistory.length - 1].number + 1 : 1;
          updateHistoryDisplay();
          updateHistoryCount();
        }
        const savedTimerState = localStorage.getItem('qrTimerState');
        if (savedTimerState) {
          const timerState = JSON.parse(savedTimerState);
          const currentTime = Date.now();
          const elapsedSeconds = Math.floor((currentTime - timerState.startTime) / 1000);
          if (timerState.active && elapsedSeconds < timerState.duration) {
            timeLeft = timerState.duration - elapsedSeconds;
            timerActive = true;
            timerStartTime = currentTime - (timerState.duration - timeLeft) * 1000;
            startTimer();
          } else if (timerState.active) {
            timeLeft = 0;
            timerActive = false;
            timerDisplay.textContent = "Time expired";
            disableAllButtonsExceptPDF();
          }
        }
      } catch (e) {
        console.error("Error loading from storage:", e);
        clearLocalStorage();
      }
    }
    function clearLocalStorage() {
      localStorage.removeItem('qrScanHistory');
      localStorage.removeItem('qrTimerState');
      scanHistory = [];
      currentScanNumber = 1;
      updateHistoryDisplay();
      updateHistoryCount();
    }
    function saveTimerState() {
      if (timerActive) {
        const timerState = {
          active: true,
          startTime: timerStartTime,
          duration: 20 * 60, // 20 minutes
          timeLeft: timeLeft
        };
        localStorage.setItem('qrTimerState', JSON.stringify(timerState));
      } else {
        localStorage.removeItem('qrTimerState');
      }
    }
    initializeFromStorage();
    fileInput.addEventListener('change', handleFileUpload);
    window.addEventListener('beforeunload', () => {
      saveTimerState();
      stopCamera();
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      if (scannerTimeout) {
        cancelAnimationFrame(scannerTimeout);
      }
    });
    function toggleHistory() {
      historySection.classList.toggle('active');
      const studentListBtn = document.querySelector('.toggle-student-list');
      if (historySection.classList.contains('active')) {
        studentListBtn.style.display = 'none';
      } else {
        studentListBtn.style.display = 'flex';
      }
    }
    function toggleStudentList() {
      if (studentListSection.classList.contains('active')) {
        studentListSection.classList.remove('active');
        studentListSection.classList.add('fade-out');
        setTimeout(() => {
          studentListSection.classList.remove('fade-out');
          studentListSection.style.display = 'none';
        }, 400);
      } else {
        studentListSection.style.display = 'flex';
        setTimeout(() => {
          studentListSection.classList.add('active');
        }, 10);
        updateStudentListDisplay();
      }
    }
    function playBeep() {
      try {
        if (beepSound.readyState >= HTMLMediaElement.HAVE_ENOUGH_DATA) {
          beepSound.currentTime = 0;
          beepSound.play().catch(e => console.log("Beep play error:", e));
        }
      } catch (e) {
        console.log("Beep error:", e);
      }
    }
    function vibrate() {
      if (navigator.vibrate) {
        navigator.vibrate(500);
      }
    }
    function startTimer() {
      timerDisplay.style.display = 'block';
      if (timerPausedTime) {
        const pausedDuration = Date.now() - timerPausedTime;
        timerStartTime += pausedDuration;
        timerPausedTime = null;
      } else if (!timerStartTime) {
        timeLeft = 20 * 60; // Changed from 30 to 20 minutes
        timerStartTime = Date.now();
      }
      timerActive = true;
      updateTimerDisplay();
      scanTimer = setInterval(() => {
        const currentTime = Date.now();
        const elapsedSeconds = Math.floor((currentTime - timerStartTime) / 1000);
        timeLeft = Math.max(0, 20 * 60 - elapsedSeconds); // Changed from 30 to 20 minutes
        updateTimerDisplay();
        if (timeLeft <= 0) {
          stopTimer();
          disableAllButtonsExceptPDF();
        }
      }, 1000);
      saveTimerState();
    }
    function stopTimer() {
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      timerActive = false;
      timerPausedTime = Date.now();
      timerDisplay.textContent = "Time expired";
      saveTimerState();
    }
    function updateTimerDisplay() {
      const minutes = Math.floor(timeLeft / 60);
      const seconds = timeLeft % 60;
      timerDisplay.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    function disableAllButtonsExceptPDF() {
      fileBtn.disabled = true;
      startBtn.disabled = true;
      fileBtn.classList.add('disabled');
      startBtn.classList.add('disabled');
      stopCamera();
      showStatus("Scanning time expired");
      // Removed the toast message here
    }
    function enableAllButtons() {
      fileBtn.disabled = false;
      startBtn.disabled = false;
      clearBtn.disabled = scanHistory.length === 0;
      fileBtn.classList.remove('disabled');
      startBtn.classList.remove('disabled');
      clearBtn.classList.remove('disabled');
      timerDisplay.style.display = 'none';
      timerActive = false;
      timerStartTime = null;
      timerPausedTime = null;
      if (scanTimer) {
        clearInterval(scanTimer);
        scanTimer = null;
      }
      localStorage.removeItem('qrTimerState');
      showStatus("Ready to scan");
      // Removed the toast message here
    }
    function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      showStatus("Processing image...");
      const reader = FileReader ? new FileReader() : new ActiveXObject('Scripting.FileSystemObject');
      reader.onload = function(ev) {
        const img = new Image();
        img.onload = function() {
          const canvas = document.createElement("canvas");
          const ctx = canvas.getContext("2d");
          canvas.width = img.width;
          canvas.height = img.height;
          ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
          try {
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            const code = jsQR(imageData.data, imageData.width, imageData.height, {
              inversionAttempts: "attemptBoth",
            });
            if (code) {
              playBeep();
              vibrate();
              processScannedCode(code.data);
              if (!timerActive) {
                startTimer();
              }
            } else {
              // Show "No QR code found" message
              showCurrentResult("❌ No QR code found");
              showStatus("No QR code in image", true);
              // Set timeout to clear error message and resume scanning
              setTimeout(() => {
                resultDiv.style.display = 'none';
                showStatus("Ready to scan.");
              }, 3500);
              
              // Try enhanced detection
              tryEnhancedDetection(canvas, ctx);
            }
          } catch (error) {
            showCurrentResult("❌ Error processing image");
            showStatus("Image processing error", true);
            console.error(error);
          }
        };
        img.onerror = () => {
          showCurrentResult("❌ Invalid image");
          showStatus("Invalid image file", true);
        };
        img.src = ev.target.result;
      };
      reader.onerror = () => {
        showCurrentResult("❌ Error reading file");
        showStatus("File read error", true);
      };
      reader.readAsDataURL(file);
    }
    function tryEnhancedDetection(canvas, ctx) {
      const tempCanvas = document.createElement("canvas");
      const tempCtx = tempCanvas.getContext("2d");
      tempCanvas.width = canvas.width;
      tempCanvas.height = canvas.height;
      const techniques = [
        () => {
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          for (let i = 0; i < data.length; i += 4) {
            const avg = (data[i] + data[i + 1] + data[i + 2]) / 3;
            data[i] = avg;
            data[i + 1] = avg;
            data[i + 2] = avg;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          tempCtx.drawImage(canvas, 0, 0);
          const imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
          const data = imageData.data;
          const factor = 1.5;
          for (let i = 0; i < data.length; i += 4) {
            data[i] = factor * (data[i] - 128) + 128;
            data[i + 1] = factor * (data[i + 1] - 128) + 128;
            data[i + 2] = factor * (data[i + 2] - 128) + 128;
          }
          tempCtx.putImageData(imageData, 0, 0);
          return tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
        },
        () => {
          return ctx.getImageData(0, 0, canvas.width, canvas.height);
        }
      ];
      for (let i = 0; i < techniques.length; i++) {
        try {
          const processedImageData = techniques[i]();
          const code = jsQR(processedImageData.data, processedImageData.width, processedImageData.height, {
            inversionAttempts: "attemptBoth",
          });
          if (code) {
            playBeep();
            vibrate();
            processScannedCode(code.data);
            if (!timerActive) {
              startTimer();
            }
            return true; // Return true if QR code found
          }
        } catch (error) {
          console.log("Enhanced technique failed:", error);
        }
      }
      return false; // Return false if no QR code found
    }
    function requestCameraPermission() {
      cameraPermission.style.display = 'none';
      startCamera();
    }
    function toggleCamera() {
      if (scanning) {
        stopCamera();
      } else {
        startCamera();
      }
    }
    function startCamera() {
      if (timerActive && timeLeft <= 0) {
        // Removed the toast message here
        return;
      }
      resultDiv.style.display = 'none';
      showStatus("Starting camera...");
      fileBtn.disabled = true;
      if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
        showStatus("Camera not supported", true);
        fileBtn.disabled = false;
        cameraPermission.style.display = 'block';
        return;
      }
      if (!timerActive) {
        startTimer();
      }
      navigator.mediaDevices.getUserMedia({
        video: {
          facingMode: "environment",
          width: { ideal: 1280 },
          height: { ideal: 720 }
        }
      })
      .then(s => {
        stream = s;
        video.srcObject = stream;
        video.style.display = 'block';
        scannerOverlay.style.display = 'block';
        scannerBox.classList.add('active');
        showStatus("Scanning..");
        video.onplaying = () => {
          scanning = true;
          startBtn.classList.remove('btn-start');
          startBtn.classList.add('btn-stop');
          scanFrame();
        };
        video.onerror = () => {
          showStatus("Camera error", true);
          stopCamera();
        };
        video.play().catch(err => {
          showStatus("Error starting camera", true);
          console.error(err);
          stopCamera();
        });
      })
      .catch(err => {
        console.error("Camera access error:", err);
        navigator.mediaDevices.getUserMedia({
          video: {
            facingMode: "user",
            width: { ideal: 1280 },
            height: { ideal: 720 }
          }
        })
        .then(s => {
          stream = s;
          video.srcObject = stream;
          video.style.display = 'block';
          scannerOverlay.style.display = 'block';
          scannerBox.classList.add('active');
          showStatus("Scanning with front camera..");
          video.onplaying = () => {
            scanning = true;
            startBtn.classList.remove('btn-start');
            startBtn.classList.add('btn-stop');
            scanFrame();
          };
        })
        .catch(err => {
          console.error("Front camera also failed:", err);
          showStatus("Camera access denied", true);
          fileBtn.disabled = false;
          cameraPermission.style.display = 'block';
          if (err.name === 'NotAllowedError') {
            // Removed the toast message here
          } else if (err.name === 'NotFoundError' || err.name === 'OverconstrainedError') {
            // Removed the toast message here
          }
        });
      });
    }
    function stopCamera() {
      scanning = false;
      fileBtn.disabled = false;
      video.pause();
      video.style.display = 'none';
      scannerOverlay.style.display = 'none';
      scannerBox.classList.remove('active');
      showStatus("Camera stopped");
      startBtn.classList.remove('btn-stop');
      startBtn.classList.add('btn-start');
      
      // Clear the no QR timeout
      if (noQRTimeout) {
        clearTimeout(noQRTimeout);
        noQRTimeout = null;
      }
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      if (scannerTimeout) {
        clearTimeout(scannerTimeout);
        scannerTimeout = null;
      }
    }
    function scanFrame() {
      if (!scanning || isPausedForResultDisplay || (timerActive && timeLeft <= 0)) {
        return;
      }
      
      // Set a timeout to stop scanning if no QR is found within 10 seconds
      if (!noQRTimeout) {
        noQRTimeout = setTimeout(() => {
          if (scanning) {
            stopCamera();
            showStatus("Scanning stopped - No QR code detected");
          }
        }, 10000); // 10 seconds
      }
      
      try {
        if (video.readyState === video.HAVE_ENOUGH_DATA) {
          const canvas = document.createElement("canvas");
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          const ctx = canvas.getContext("2d");
          ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const code = jsQR(imageData.data, canvas.width, canvas.height, {
            inversionAttempts: "dontInvert",
          });
          if (code) {
            // Clear the timeout when a QR code is found
            if (noQRTimeout) {
              clearTimeout(noQRTimeout);
              noQRTimeout = null;
            }
            
            playBeep();
            vibrate();
            processScannedCode(code.data);
            return;
          }
        }
        scannerTimeout = requestAnimationFrame(scanFrame);
      } catch (error) {
        console.error("Scan error:", error);
        showStatus("Scan error occurred", true);
        stopCamera();
      }
    }
    function processScannedCode(content) {
      if (content === lastScannedContent) {
        showDuplicateWarning();
        return;
      }
      const isDuplicate = scanHistory.some(item => item.content === content);
      if (isDuplicate) {
        showDuplicateWarning();
        return;
      }
      
      // Check for required fields: Full name, phone, gender
      const extractedData = extractDataFromContent(content);
      const hasFullName = extractedData.fullName && extractedData.fullName.trim() !== "" && extractedData.fullName !== "N/A";
      const hasPhone = extractedData.phone && extractedData.phone.trim() !== "" && extractedData.phone !== "N/A";
      const hasGender = extractedData.gender && extractedData.gender.trim() !== "" && extractedData.gender !== "N/A";
      
      if (!hasFullName || !hasPhone || !hasGender) {
        // Show 404 error for 2 seconds
        showCurrentResult("404");
        showStatus("Missing required fields", true);
        
        // Resume scanning after 2 seconds
        setTimeout(() => {
          resultDiv.style.display = 'none';
          showStatus("Ready to scan.");
          if (scanning) {
            scanFrame();
          }
        }, 2000);
        return;
      }
      
      lastScannedContent = content;
      addToHistory(content);
      // Removed the success message display here
      showStatus("Scan successful!");
      // Removed the toast message here
      isPausedForResultDisplay = true;
      setTimeout(() => {
        isPausedForResultDisplay = false;
        resultDiv.style.display = 'none';
        showStatus("Ready to scan...");
        if (scanning) {
          scanFrame();
        }
      }, 2000);
    }
    function showDuplicateWarning() {
      showStatus("Duplicate detected!", true);
      showCurrentResult("⚠️ Duplicate QR");
      if (duplicateWarningTimeout) {
        clearTimeout(duplicateWarningTimeout);
      }
      duplicateWarningTimeout = setTimeout(() => {
        resultDiv.style.display = 'none';
        showStatus("Ready to scan.");
        // Automatically resume scanning if camera is active
        if (scanning) {
          scanFrame();
        }
      }, 3000);
    }
    function addToHistory(content) {
      if (!content || content.startsWith("❌")) return;
      const timestamp = new Date().toLocaleString();
      const scanItem = {
        number: currentScanNumber++,
        content: content,
        timestamp: timestamp
      };
      scanHistory.push(scanItem);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
    }
    function showCurrentResult(text) {
      resultDiv.innerHTML = text;
      resultDiv.style.display = 'block';
    }
    function updateHistoryDisplay() {
      if (scanHistory.length === 0) {
        historyList.innerHTML = '<div class="empty-history">No scans yet</div>';
        return;
      }
      historyList.innerHTML = '';
      scanHistory.forEach(item => {
        const historyItem = document.createElement('div');
        historyItem.className = 'history-item';
        historyItem.innerHTML = `
          <div class="history-item-header">
            <div class="history-item-number">${item.number}.</div>
            <div class="history-item-actions">
              <button class="history-item-btn" onclick="deleteHistoryItem(${item.number}, event)" title="Delete">✕</button>
            </div>
          </div>
          <div class="history-item-content">${item.content}</div>
          <div class="history-item-timestamp">${item.timestamp}</div>
        `;
        historyList.appendChild(historyItem);
      });
      historyList.scrollTop = historyList.scrollHeight;
    }
    function updateHistoryCount() {
      const count = scanHistory.length;
      historyCount.textContent = `${count} ${count === 1 ? 'item' : 'items'}`;
      downloadBtn.disabled = count === 0;
      clearBtn.disabled = count === 0;
    }
    function updateStudentListDisplay() {
      if (scanHistory.length === 0) {
        studentListContent.innerHTML = '<div class="empty-student-list">No students scanned yet</div>';
        return;
      }
      // Sort by fullName A-Z
      const studentData = scanHistory.map((item, index) => {
        const extractedData = extractDataFromContent(item.content);
        return {
          number: index + 1,
          fullName: extractedData.fullName || "N/A",
          phone: extractedData.phone || "N/A",
          gender: extractedData.gender || "N/A",
          timestamp: item.timestamp
        };
      }).sort((a, b) => a.fullName.localeCompare(b.fullName, undefined, { sensitivity: 'base' }));
      let tableHTML = `
        <div style="flex: 1; overflow-y: auto;">
          <table class="student-table">
            <thead>
              <tr>
                <th>#</th>
                <th>Full Name</th>
                <th>Phone</th>
                <th>Gender</th>
                <th>Date & Time</th>
              </tr>
            </thead>
            <tbody>
      `;
      studentData.forEach((student, idx) => {
        tableHTML += `
          <tr>
            <td>${idx + 1}</td>
            <td>${student.fullName}</td>
            <td>${student.phone}</td>
            <td>${student.gender}</td>
            <td>${student.timestamp}</td>
          </tr>
        `;
      });
      tableHTML += `
            </tbody>
          </table>
        </div>
      `;
      studentListContent.innerHTML = tableHTML;
    }
    function extractDataFromContent(content) {
      try {
        const data = JSON.parse(content);
        return {
          fullName: data.fullName || data.name || data.Name || data.FullName || data.nama || data.Nama || "",
          phone: data.phone || data.mobile || data.Phone || data.Mobile || data.telepon || data.Telepon || "",
          gender: data.gender || data.Gender || data.jenisKelamin || data.JenisKelamin || "",
          timestamp: new Date().toLocaleString()
        };
      } catch (e) {
        const nameMatch = content.match(/full name[:=\s]*([^\n,]+)/i);
        const phoneMatch = content.match(/(?:phone|mobile|tel|telepon|telefono|hp|handphone)[:=\s]*([+\d\s\-()]+)/i);
        const genderMatch = content.match(/(?:gender|jenis kelamin|sex)[:=\s]*([^\n,]+)/i);
        let extractedName = nameMatch ? nameMatch[1].trim() : "";
        if (!extractedName) {
          const lines = content.split('\n');
          for (const line of lines) {
            if (line.match(/^[A-Za-z\s\.]+$/) && line.trim().length > 3) {
              extractedName = line.trim();
              break;
            }
          }
        }
        return {
          fullName: extractedName,
          phone: phoneMatch ? phoneMatch[1].trim() : "",
          gender: genderMatch ? genderMatch[1].trim() : "",
          timestamp: new Date().toLocaleString()
        };
      }
    }
    function downloadPDF() {
      if (scanHistory.length === 0) {
        // Removed the toast message here
        return;
      }
      try {
        if (typeof window.jspdf === 'undefined') {
          // Removed the toast message here
          downloadTextFallback();
          return;
        }
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        doc.setFillColor(51, 1, 31);
        doc.rect(0, 0, 220, 20, 'F');
        doc.setFontSize(16);
        doc.setTextColor(255, 255, 255);
        doc.text("Hamerenoh Student Atendans", 105, 12, { align: "center" });
        doc.setFontSize(10);
        doc.setTextColor(255, 255, 255);
        const date = new Date().toLocaleDateString();
        const time = new Date().toLocaleTimeString();
        doc.text(`On: ${date} ${time}`, 105, 18, { align: "center" });
        doc.setTextColor(0, 0, 0);
        // Sort by fullName A-Z
        const tableData = scanHistory
          .map((item, index) => {
            const extractedData = extractDataFromContent(item.content);
            return [
              extractedData.fullName || "N/A",
              extractedData.phone || "N/A",
              extractedData.gender || "N/A",
              item.timestamp
            ];
          })
          .sort((a, b) => a[0].localeCompare(b[0], undefined, { sensitivity: 'base' }))
          .map((row, idx) => [idx + 1, ...row]);
        doc.autoTable({
          head: [['#', 'Full Name', 'Phone', 'Gender', 'Date & Time']],
          body: tableData,
          startY: 30,
          theme: 'grid',
          styles: {
            fontSize: 9,
            cellPadding: 3,
            overflow: 'linebreak'
          },
          headStyles: {
            fillColor: [51, 1, 31],
            textColor: 255,
            fontStyle: 'bold',
            fontSize: 10
          },
          alternateRowStyles: {
            fillColor: [241, 245, 249]
          },
          columnStyles: {
            0: { cellWidth: 10 },
            1: { cellWidth: 60 },
            2: { cellWidth: 35 },
            3: { cellWidth: 25 },
            4: { cellWidth: 45 }
          },
          margin: { top: 25 }
        });
        const pageCount = doc.internal.getNumberOfPages();
        for (let i = 1; i <= pageCount; i++) {
          doc.setPage(i);
          doc.setFontSize(10);
          doc.setTextColor(100, 100, 100);
          doc.text(`${pageCount}`, 200, 285, { align: "right" });
        }
        const dateStr = new Date().toISOString().slice(0, 10);
        const pdfDataUri = doc.output('datauristring');
        const downloadLink = document.createElement('a');
        downloadLink.href = pdfDataUri;
        downloadLink.download = `የእሁድ መርሃግብር አቴንዳንስ ሐመረ-ኖኅ_ሰንበት _ት/ቤት_${dateStr}.pdf`;
        document.body.appendChild(downloadLink);
        downloadLink.click();
        document.body.removeChild(downloadLink);
        // Removed the toast message here
      } catch (e) {
        console.error("PDF export error:", e);
        // Removed the toast message here
        downloadTextFallback();
      }
    }
    function downloadTextFallback() {
      try {
        let textContent = "QR Code Scan Report\n\n";
        textContent += "Generated on: " + new Date().toLocaleDateString() + " at " + new Date().toLocaleTimeString() + "\n\n";
        scanHistory.forEach((item, index) => {
          const extractedData = extractDataFromContent(item.content);
          textContent += `${index + 1}. ${extractedData.fullName || "N/A"} | ${extractedData.phone || "N/A"} | ${extractedData.gender || "N/A"} | ${item.timestamp}\n`;
        });
        const blob = new Blob([textContent], { type: 'text/plain' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `QR_Scan_Report_${new Date().toISOString().slice(0, 10)}.txt`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        // Removed the toast message here
      } catch (fallbackError) {
        console.error("Fallback also failed:", fallbackError);
        // Removed the toast message here
      }
    }
    function deleteHistoryItem(number, event) {
      event.stopPropagation();
      scanHistory = scanHistory.filter(i => i.number !== number);
      updateHistoryDisplay();
      updateHistoryCount();
      saveHistory();
      // Removed the toast message here
    }
    function clearHistory() {
      if (scanHistory.length === 0) {
        // Removed the toast message here
        return;
      }
      if (confirm("Are you sure you want to clear all scan history?")) {
        scanHistory = [];
        currentScanNumber = 1;
        lastScannedContent = null;
        updateHistoryDisplay();
        updateHistoryCount();
        saveHistory();
        // Removed the toast message here
      }
    }
    function saveHistory() {
      try {
        localStorage.setItem('qrScanHistory', JSON.stringify(scanHistory));
      } catch (e) {
        console.error("Error saving history:", e);
        // Removed the toast message here
      }
    }
    function showStatus(message, isError = false) {
      statusText.textContent = message;
      statusText.className = isError ? 'status error-text' : 'status';
    }
    function showToast(message, duration = 2000, isError = false) {
      toast.textContent = message;
      toast.className = isError ? 'toast error-text' : 'toast';
      toast.classList.add('show');
      setTimeout(() => {
        toast.classList.remove('show');
      }, duration);
    }
    updateHistoryCount();
  </script>
</body>
</html>